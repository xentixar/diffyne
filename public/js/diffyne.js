!function(){"use strict";class e{constructor(e={}){this.config={transport:e.transport||"ajax",wsUrl:e.wsUrl||"ws://localhost:8080/diffyne",endpoint:e.endpoint||"/_diffyne",debug:e.debug||!1,...e},this.components=new Map,this.ws=null,this.requestQueue=[],this.processing=!1,this.init()}init(){this.log("Initializing Diffyne..."),"websocket"===this.config.transport&&this.connectWebSocket(),this.hydrateComponents(),this.observeDOMChanges()}hydrateComponents(){document.querySelectorAll("[diffyne\\:id]").forEach(e=>{const t=e.getAttribute("diffyne:id"),n=e.getAttribute("diffyne:class"),o=e.getAttribute("diffyne:name"),s=this.parseJSON(e.getAttribute("diffyne:state")||"{}"),i=e.getAttribute("diffyne:fingerprint");this.components.set(t,{id:t,componentClass:n,componentName:o,element:e,state:s,fingerprint:i,vdom:this.buildVDOM(e)}),this.bindEvents(e,t),this.log(`Hydrated component: ${t} (${o})`)})}buildVDOM(e){return{tag:e.tagName.toLowerCase(),attrs:this.getAttributes(e),children:Array.from(e.childNodes).map(e=>e.nodeType===Node.TEXT_NODE?{type:"text",value:e.textContent}:e.nodeType===Node.ELEMENT_NODE?this.buildVDOM(e):null).filter(Boolean)}}getAttributes(e){const t={};return Array.from(e.attributes).forEach(e=>{t[e.name]=e.value}),t}bindEvents(e,t){const n=e;n.hasAttribute("data-diffyne-delegated")||(n.setAttribute("data-diffyne-delegated","true"),n.addEventListener("click",e=>{const o=e.target.closest("[diffyne\\:click]");if(o&&n.contains(o)){const n=o.getAttribute("diffyne:click");this.handleAction(t,n,e)}}),n.addEventListener("change",e=>{const o=e.target.closest("[diffyne\\:change]");if(o&&n.contains(o)){const n=o.getAttribute("diffyne:change");this.handleAction(t,n,e)}}),n.addEventListener("input",e=>{const n=e.target;if(n.hasAttribute("diffyne:model")){const e=n.getAttribute("diffyne:model"),o=this.parseModifiers(e);if(!n._diffyneModelHandler){let e=e=>this.handleModelUpdate(t,o.property,e);o.debounce&&(e=this.debounce(e,o.debounce)),n._diffyneModelHandler=e}n._diffyneModelHandler(n.value)}}),n.addEventListener("change",e=>{const n=e.target;if(n.hasAttribute("diffyne:model")){const e=n.getAttribute("diffyne:model"),o=this.parseModifiers(e);(o.lazy||"SELECT"===n.tagName||"checkbox"===n.type||"radio"===n.type)&&this.handleModelUpdate(t,o.property,n.value)}}),n.addEventListener("submit",e=>{const o=e.target.closest("[diffyne\\:submit]");if(o&&n.contains(o)){e.preventDefault();const n=o.getAttribute("diffyne:submit");this.handleAction(t,n,e)}}),n.querySelectorAll("[diffyne\\:poll]").forEach(e=>{if(e.hasAttribute("data-diffyne-poll-bound"))return;e.setAttribute("data-diffyne-poll-bound","true");const n=parseInt(e.getAttribute("diffyne:poll"))||2e3,o=e.getAttribute("diffyne:poll.action")||"refresh";setInterval(()=>{this.handleAction(t,o)},n)}))}parseModifiers(e){const t=e.split("."),n={property:t[0],live:t.includes("live"),lazy:t.includes("lazy"),debounce:null},o=t.findIndex(e=>"debounce"===e);return o>=0&&t[o+1]?n.debounce=parseInt(t[o+1]):n.live&&(n.debounce=150),n}getModelEventType(e,t){if(t.lazy)return"change";const n=e.tagName.toLowerCase(),o=e.type;return"select"===n||"checkbox"===o||"radio"===o?"change":"input"}async handleAction(e,t,n=null){const[o,...s]=this.parseAction(t);this.log(`Action: ${o}`,s),await this.callMethod(e,o,s)}async handleModelUpdate(e,t,n){this.log(`Model update: ${t} = ${n}`),await this.updateProperty(e,t,n)}parseAction(e){const t=e.match(/^(\w+)(?:\((.*)\))?$/);if(!t)return[e];const n=t[1],o=t[2];if(!o)return[n];return[n,...o.split(",").map(e=>(e=e.trim()).startsWith("'")||e.startsWith('"')?e.slice(1,-1):isNaN(e)?"true"===e||"false"!==e&&e:Number(e))]}async callMethod(e,t,n=[]){const o=this.components.get(e);if(o){this.showLoading(o.element);try{const s=await this.request({type:"call",componentId:e,componentClass:o.componentClass,componentName:o.componentName,method:t,params:n,state:o.state,fingerprint:o.fingerprint,previousHtml:o.element.firstElementChild?.innerHTML||""});this.applyPatches(e,s)}catch(s){this.handleError(s)}finally{this.hideLoading(o.element)}}}async updateProperty(e,t,n){const o=this.components.get(e);if(o){o.state[t]=n;try{const s=await this.request({type:"update",componentId:e,componentClass:o.componentClass,componentName:o.componentName,property:t,value:n,state:o.state,fingerprint:o.fingerprint,previousHtml:o.element.firstElementChild?.innerHTML||""});this.applyPatches(e,s)}catch(s){this.handleError(s)}}}async request(e){return"websocket"===this.config.transport?this.sendWebSocket(e):this.sendAjax(e)}async sendAjax(e){const t=await fetch(this.config.endpoint,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":this.getCsrfToken()},body:JSON.stringify(e)});if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);return await t.json()}sendWebSocket(e){return new Promise((t,n)=>{if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return void n(new Error("WebSocket not connected"));const o=this.generateId();e.requestId=o;const s=e=>{const n=JSON.parse(e.data);n.requestId===o&&(this.ws.removeEventListener("message",s),t(n))};this.ws.addEventListener("message",s),this.ws.send(JSON.stringify(e)),setTimeout(()=>{this.ws.removeEventListener("message",s),n(new Error("Request timeout"))},3e4)})}connectWebSocket(){this.log("Connecting to WebSocket..."),this.ws=new WebSocket(this.config.wsUrl),this.ws.onopen=()=>{this.log("WebSocket connected")},this.ws.onclose=()=>{this.log("WebSocket disconnected"),setTimeout(()=>this.connectWebSocket(),3e3)},this.ws.onerror=e=>{this.log("WebSocket error:",e)}}applyPatches(e,t){const n=this.components.get(e);if(!n)return;const o=void 0!==t.s?t.s:t.success,s=t.c||t.component;if(!o||!s)return void this.log("Invalid response format");const i=s.p||s.patches||[],r=s.st||s.state,a=s.f||s.fingerprint;this.log(`Applying ${i.length} patches to ${e}`,i);const d=n.element.firstElementChild;d?(i.forEach(e=>{this.applyPatch(d,e)}),r&&(n.state=r,n.element.setAttribute("diffyne:state",JSON.stringify(r))),a&&(n.fingerprint=a,n.element.setAttribute("diffyne:fingerprint",a))):this.log("No content root found in component wrapper")}applyPatch(e,t){const n=t.t||t.type,o=t.p||t.path,s=t.d||t.data,i=this.getNodeByPath(e,o);if(!i)return void this.log("Target node not found for path:",o);switch(this.expandType(n)){case"create":this.patchCreate(i,s);break;case"remove":this.patchRemove(i);break;case"replace":this.patchReplace(i,s);break;case"update_text":this.patchUpdateText(i,s);break;case"update_attrs":this.patchUpdateAttrs(i,s);break;case"reorder":this.patchReorder(i,s)}}expandType(e){return{c:"create",r:"remove",R:"replace",t:"update_text",a:"update_attrs",o:"reorder"}[e]||e}getNodeByPath(e,t){let n=e;for(const o of t){if(!n)return null;const e=Array.from(n.childNodes).filter(e=>e.nodeType!==Node.TEXT_NODE||""!==e.textContent.trim());if(!e[o])return null;n=e[o]}return n}patchCreate(e,t){const n=this.vnodeToDOM(t.node);e.appendChild(n)}patchRemove(e){e.parentNode?.removeChild(e)}patchReplace(e,t){const n=this.vnodeToDOM(t.node);e.parentNode?.replaceChild(n,e)}patchUpdateText(e,t){e.nodeType===Node.TEXT_NODE&&(e.textContent=t.x||t.text)}patchUpdateAttrs(e,t){const n=t.s||t.set||{},o=t.r||t.remove||[];Object.entries(n).forEach(([t,n])=>{e.setAttribute(t,n)}),o.forEach(t=>{e.removeAttribute(t)})}patchReorder(e,t){t.moves.forEach(t=>{const n=e.childNodes[t.from];n&&e.insertBefore(n,e.childNodes[t.to])})}vnodeToDOM(e){if(void 0!==e.x)return document.createTextNode(e.x);if(void 0!==e.m)return document.createComment(e.m);if(e.t){const t=document.createElement(e.t),n=e.a||e.attributes||{};Object.entries(n).forEach(([e,n])=>{t.setAttribute(e,n)});return(e.c||e.children||[]).forEach(e=>{t.appendChild(this.vnodeToDOM(e))}),t}if("text"===e.type)return document.createTextNode(e.text);if("element"===e.type){const t=document.createElement(e.tag);return Object.entries(e.attributes||{}).forEach(([e,n])=>{t.setAttribute(e,n)}),(e.children||[]).forEach(e=>{t.appendChild(this.vnodeToDOM(e))}),t}return document.createTextNode("")}showLoading(e){e.querySelectorAll("[diffyne\\:loading]").forEach(e=>{const t=e.getAttribute("diffyne:loading");if(t.includes("class")){const n=t.split(".").pop();e.classList.add(n)}else e.style.opacity="0.5",e.style.pointerEvents="none"})}hideLoading(e){e.querySelectorAll("[diffyne\\:loading]").forEach(e=>{const t=e.getAttribute("diffyne:loading");if(t.includes("class")){const n=t.split(".").pop();e.classList.remove(n)}else e.style.opacity="",e.style.pointerEvents=""})}observeDOMChanges(){new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{if(e.nodeType===Node.ELEMENT_NODE){e.querySelectorAll("[diffyne\\:id]").forEach(e=>this.hydrateComponent(e))}})})}).observe(document.body,{childList:!0,subtree:!0})}debounce(e,t){let n;return function(...o){clearTimeout(n),n=setTimeout(()=>e.apply(this,o),t)}}parseJSON(e){try{return JSON.parse(e)}catch{return{}}}getCsrfToken(){const e=document.querySelector('meta[name="csrf-token"]');return e?e.getAttribute("content"):""}generateId(){return"req-"+Math.random().toString(36).substr(2,9)}log(...e){this.config.debug&&console.log("[Diffyne]",...e)}handleError(e){console.error("[Diffyne Error]",e)}}"undefined"!=typeof window&&(window.Diffyne=e,document.addEventListener("DOMContentLoaded",()=>{const t=window.diffyneConfig||{};window.diffyne=new e(t)})),"undefined"!=typeof module&&module.exports&&(module.exports=e)}();
