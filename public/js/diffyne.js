!function(){"use strict";class e{constructor(e={}){this.config={transport:e.transport||"ajax",wsUrl:e.wsUrl||"ws://localhost:8080/diffyne",endpoint:e.endpoint||"/_diffyne",debug:e.debug||!1,...e},this.components=new Map,this.ws=null,this.requestQueue=[],this.processing=!1,this.lazyLoadQueue=[],this.init()}init(){this.log("Initializing Diffyne..."),"websocket"===this.config.transport&&this.connectWebSocket(),this.hydrateComponents(),setTimeout(()=>this.loadLazyComponents(),100),this.observeDOMChanges(),window.addEventListener("popstate",()=>{this.log("Browser navigation detected, reloading page"),window.location.reload()})}hydrateComponents(){document.querySelectorAll("[diff\\:id]").forEach(e=>{if(e.hasAttribute("data-diffyne-lazy"))return;const t=e.getAttribute("diff:id"),r=e.getAttribute("diff:class"),o=e.getAttribute("diff:name"),n=this.parseJSON(e.getAttribute("diff:state")||"{}"),s=e.getAttribute("diff:fingerprint");this.components.set(t,{id:t,componentClass:r,componentName:o,element:e,state:n,fingerprint:s,vdom:this.buildVDOM(e),errors:{}}),this.syncModelInputs(e,n),this.bindEvents(e,t),this.log(`Hydrated component: ${t} (${o})`)})}loadLazyComponents(){document.querySelectorAll("[data-diffyne-lazy]").forEach(e=>{this.loadLazyComponent(e)})}async loadLazyComponent(e){const t=e.getAttribute("diff:id"),r=e.getAttribute("diff:class"),o=e.getAttribute("diff:name"),n=this.parseJSON(e.getAttribute("diff:params")||"{}"),s=new URLSearchParams(window.location.search),i={};for(const[d,l]of s)i[d]=l;this.log(`Loading lazy component: ${t} (${o})`);try{const s=await fetch(`${this.config.endpoint}/lazy`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":this.getCsrfToken(),Accept:"application/json"},body:JSON.stringify({componentClass:r,componentId:t,params:n,queryParams:i})}),a=await s.json();a.success?(e.setAttribute("diff:state",JSON.stringify(a.state)),e.setAttribute("diff:fingerprint",a.fingerprint),e.removeAttribute("data-diffyne-lazy"),e.setAttribute("data-diffyne-loaded",""),e.innerHTML=a.html,this.components.set(t,{id:t,componentClass:r,componentName:o,element:e,state:a.state,fingerprint:a.fingerprint,vdom:this.buildVDOM(e),errors:{}}),this.syncModelInputs(e,a.state),this.bindEvents(e,t),this.log(`Lazy component loaded: ${t} (${o})`)):(console.error("Failed to load lazy component:",a.error),e.innerHTML=`<div style="color: red; padding: 1rem;">Failed to load component: ${a.error}</div>`)}catch(a){console.error("Error loading lazy component:",a),e.innerHTML='<div style="color: red; padding: 1rem;">Error loading component</div>'}}buildVDOM(e){return{tag:e.tagName.toLowerCase(),attrs:this.getAttributes(e),children:Array.from(e.childNodes).map(e=>e.nodeType===Node.TEXT_NODE?{type:"text",value:e.textContent}:e.nodeType===Node.ELEMENT_NODE?this.buildVDOM(e):null).filter(Boolean)}}getAttributes(e){const t={};return Array.from(e.attributes).forEach(e=>{t[e.name]=e.value}),t}bindEvents(e,t){const r=e;r.hasAttribute("data-diffyne-delegated")||(r.setAttribute("data-diffyne-delegated","true"),r.addEventListener("click",e=>{const o=e.target.closest("[diff\\:click]");if(o&&r.contains(o)){const r=o.getAttribute("diff:click");this.handleAction(t,r,e)}}),r.addEventListener("change",e=>{const o=e.target.closest("[diff\\:change]");if(o&&r.contains(o)){const r=o.getAttribute("diff:change");this.handleAction(t,r,e)}}),r.addEventListener("input",e=>{const r=e.target,o=Array.from(r.attributes).find(e=>"diff:model"===e.name||e.name.startsWith("diff:model."));if(o){const e=r.getAttribute(o.name),n=this.parseModifiers(o.name,e);if(n.live){if(!r._diffyneModelHandler){let e=e=>this.handleModelUpdate(t,n.property,e);n.debounce&&(e=this.debounce(e,n.debounce)),r._diffyneModelHandler=e}r._diffyneModelHandler(r.value)}else this.updateLocalState(t,n.property,r.value)}}),r.addEventListener("change",e=>{const r=e.target,o=Array.from(r.attributes).find(e=>"diff:model"===e.name||e.name.startsWith("diff:model."));if(o){const e=r.getAttribute(o.name),n=this.parseModifiers(o.name,e);n.lazy||"SELECT"===r.tagName||"checkbox"===r.type||"radio"===r.type?this.handleModelUpdate(t,n.property,r.value):n.live||this.updateLocalState(t,n.property,r.value)}}),r.addEventListener("submit",e=>{const o=e.target.closest("[diff\\:submit]");if(o&&r.contains(o)){e.preventDefault();const r=o.getAttribute("diff:submit");this.handleAction(t,r,e)}}),r.querySelectorAll("[diff\\:poll]").forEach(e=>{if(e.hasAttribute("data-diffyne-poll-bound"))return;e.setAttribute("data-diffyne-poll-bound","true");const r=parseInt(e.getAttribute("diff:poll"))||2e3,o=e.getAttribute("diff:poll.action")||"refresh";setInterval(()=>{this.handleAction(t,o)},r)}))}parseModifiers(e,t){const r=e.split("."),o={property:t,live:r.includes("live"),lazy:r.includes("lazy"),debounce:null},n=r.findIndex(e=>"debounce"===e);return n>=0&&r[n+1]?o.debounce=parseInt(r[n+1]):o.live&&(o.debounce=150),o}getModelEventType(e,t){if(t.lazy)return"change";const r=e.tagName.toLowerCase(),o=e.type;return"select"===r||"checkbox"===o||"radio"===o?"change":"input"}async handleAction(e,t,r=null){const[o,...n]=this.parseAction(t);this.log(`Action: ${o}`,n),await this.callMethod(e,o,n)}async handleModelUpdate(e,t,r){this.log(`Model update: ${t} = ${r}`),await this.updateProperty(e,t,r)}updateLocalState(e,t,r){const o=this.components.get(e);o&&(o.state[t]=r,this.log(`Local state update: ${t} = ${r}`))}parseAction(e){const t=e.match(/^(\w+)(?:\((.*)\))?$/);if(!t)return[e];const r=t[1],o=t[2];if(!o)return[r];return[r,...o.split(",").map(e=>(e=e.trim()).startsWith("'")||e.startsWith('"')?e.slice(1,-1):isNaN(e)?"true"===e||"false"!==e&&e:Number(e))]}async callMethod(e,t,r=[]){const o=this.components.get(e);if(o){this.showLoading(o.element);try{const n=await this.request({type:"call",componentId:e,componentClass:o.componentClass,method:t,params:r,state:o.state,fingerprint:o.fingerprint});this.applyPatches(e,n)}catch(n){"validation_error"===n.type&&n.details?.errors?(o.errors=n.details.errors,this.displayErrors(o.element,n.details.errors)):this.handleError(n)}finally{this.hideLoading(o.element)}}}async updateProperty(e,t,r){const o=this.components.get(e);if(o){o.state[t]=r;try{const n=await this.request({type:"update",componentId:e,componentClass:o.componentClass,property:t,value:r,state:o.state,fingerprint:o.fingerprint});this.applyPatches(e,n)}catch(n){"validation_error"===n.type&&n.details?.errors?(o.errors=n.details.errors,this.displayErrors(o.element,n.details.errors)):this.handleError(n)}}}async request(e){return"websocket"===this.config.transport?this.sendWebSocket(e):this.sendAjax(e)}async sendAjax(e){const t=await fetch(this.config.endpoint,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":this.getCsrfToken()},body:JSON.stringify(e)}),r=await t.json();if(!t.ok||!r.s){const e=new Error(r.error||`HTTP ${t.status}: ${t.statusText}`);throw e.type=r.type,e.details=r,e}return r}sendWebSocket(e){return new Promise((t,r)=>{if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return void r(new Error("WebSocket not connected"));const o=this.generateId();e.requestId=o;const n=e=>{const r=JSON.parse(e.data);r.requestId===o&&(this.ws.removeEventListener("message",n),t(r))};this.ws.addEventListener("message",n),this.ws.send(JSON.stringify(e)),setTimeout(()=>{this.ws.removeEventListener("message",n),r(new Error("Request timeout"))},3e4)})}connectWebSocket(){this.log("Connecting to WebSocket..."),this.ws=new WebSocket(this.config.wsUrl),this.ws.onopen=()=>{this.log("WebSocket connected")},this.ws.onclose=()=>{this.log("WebSocket disconnected"),setTimeout(()=>this.connectWebSocket(),3e3)},this.ws.onerror=e=>{this.log("WebSocket error:",e)}}applyPatches(e,t){const r=this.components.get(e);if(!r)return;const o=void 0!==t.s?t.s:t.success;if(o&&t.redirect)return void this.handleRedirect(t.redirect);const n=t.c||t.component;if(!o||!n)return void this.log("Invalid response format");const s=n.p||n.patches||[],i=n.st||n.state,a=n.f||n.fingerprint,d=n.e||n.errors,l=n.q||n.queryString;this.log(`Applying ${s.length} patches to ${e}`,s);const c=r.element.firstElementChild;if(c){if(1!==s.length||"c"!==s[0].t&&"create"!==s[0].type||0!==s[0].p?.length&&0!==s[0].path?.length)s.forEach(e=>{this.applyPatch(c,e)});else{const e=s[0],t=e.d||e.data,o=this.vnodeToDOM(t.node);r.element.replaceChild(o,c)}i&&(r.state=i,r.element.setAttribute("diff:state",JSON.stringify(i)),this.syncModelInputs(r.element,i)),a&&(r.fingerprint=a,r.element.setAttribute("diff:fingerprint",a)),l&&this.updateQueryString(l),d?(r.errors=d,this.displayErrors(r.element,d)):(r.errors={},this.clearErrors(r.element))}else this.log("No content root found in component wrapper")}displayErrors(e,t){this.clearErrors(e),Object.entries(t).forEach(([t,r])=>{const o=e.querySelector(`[name="${t}"], [diff\\:model="${t}"]`);if(o){o.classList.add("diffyne-error"),o.setAttribute("aria-invalid","true");const n=e.querySelector(`[diff\\:error="${t}"]`);if(n)n.textContent=Array.isArray(r)?r[0]:r,n.style.display="";else{const e=document.createElement("span");e.className="diffyne-error-message",e.textContent=Array.isArray(r)?r[0]:r,e.style.color="#ef4444",e.style.fontSize="0.875rem",e.style.marginTop="0.25rem",o.parentNode&&o.parentNode.insertBefore(e,o.nextSibling)}}})}clearErrors(e){e.querySelectorAll(".diffyne-error").forEach(e=>{e.classList.remove("diffyne-error"),e.removeAttribute("aria-invalid")}),e.querySelectorAll("[diff\\:error]").forEach(e=>{e.textContent="",e.style.display="none"}),e.querySelectorAll(".diffyne-error-message").forEach(e=>{e.remove()})}syncModelInputs(e,t){Array.from(e.querySelectorAll("*")).filter(e=>Array.from(e.attributes).some(e=>"diff:model"===e.name||e.name.startsWith("diff:model."))).forEach(e=>{const r=Array.from(e.attributes).find(e=>"diff:model"===e.name||e.name.startsWith("diff:model."));if(!r)return;const o=e.getAttribute(r.name),n=this.parseModifiers(r.name,o).property;if(t.hasOwnProperty(n)){const r=t[n]??"";"INPUT"===e.tagName||"TEXTAREA"===e.tagName?e.value!==r&&(e.value=r):"SELECT"===e.tagName&&e.value!==r&&(e.value=r)}})}applyPatch(e,t){const r=t.t||t.type,o=t.p||t.path,n=t.d||t.data,s=this.expandType(r);let i,a;if("create"===s&&o.length>0){const t=o.slice(0,-1);a=o[o.length-1],i=this.getNodeByPath(e,t)}else i=this.getNodeByPath(e,o),a=null;if(i)switch(s){case"create":this.patchCreate(i,n,a);break;case"remove":this.patchRemove(i);break;case"replace":this.patchReplace(i,n);break;case"update_text":this.patchUpdateText(i,n);break;case"update_attrs":this.patchUpdateAttrs(i,n);break;case"reorder":this.patchReorder(i,n)}else this.log("Target node not found for path:",o)}expandType(e){return{c:"create",r:"remove",R:"replace",t:"update_text",a:"update_attrs",o:"reorder"}[e]||e}getNodeByPath(e,t){let r=e;for(const o of t){if(!r)return null;const e=Array.from(r.childNodes).filter(e=>e.nodeType!==Node.TEXT_NODE||""!==e.textContent.trim());if(!e[o])return null;r=e[o]}return r}patchCreate(e,t,r=null){const o=this.vnodeToDOM(t.node);if(null!==r){const t=Array.from(e.childNodes).filter(e=>e.nodeType!==Node.TEXT_NODE||""!==e.textContent.trim())[r];t?e.insertBefore(o,t):e.appendChild(o)}else e.appendChild(o)}patchRemove(e){e.parentNode?.removeChild(e)}patchReplace(e,t){const r=this.vnodeToDOM(t.node);e.parentNode?.replaceChild(r,e)}patchUpdateText(e,t){e.nodeType===Node.TEXT_NODE&&(e.textContent=t.x||t.text)}patchUpdateAttrs(e,t){const r=t.s||t.set||{},o=t.r||t.remove||[];Object.entries(r).forEach(([t,r])=>{e.setAttribute(t,r),"INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName&&"SELECT"!==e.tagName||"value"!==t||(e.value=r)}),o.forEach(t=>{e.removeAttribute(t),"INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName&&"SELECT"!==e.tagName||"value"!==t||(e.value="")})}patchReorder(e,t){t.moves.forEach(t=>{const r=e.childNodes[t.from];r&&e.insertBefore(r,e.childNodes[t.to])})}vnodeToDOM(e){if(void 0!==e.x)return document.createTextNode(e.x);if(void 0!==e.m)return document.createComment(e.m);if(e.t){const t=document.createElement(e.t),r=e.a||e.attributes||{};Object.entries(r).forEach(([e,r])=>{t.setAttribute(e,r)});return(e.c||e.children||[]).forEach(e=>{t.appendChild(this.vnodeToDOM(e))}),t}if("text"===e.type)return document.createTextNode(e.text);if("element"===e.type){const t=document.createElement(e.tag);return Object.entries(e.attributes||{}).forEach(([e,r])=>{t.setAttribute(e,r)}),(e.children||[]).forEach(e=>{t.appendChild(this.vnodeToDOM(e))}),t}return document.createTextNode("")}showLoading(e){Array.from(e.querySelectorAll("*")).filter(e=>Array.from(e.attributes).some(e=>e.name.startsWith("diff:loading"))).forEach(e=>{const t=Array.from(e.attributes).find(e=>e.name.startsWith("diff:loading"));if(!t)return;t.value;const r=t.name.split(".");if(r.includes("class")){const t=r.indexOf("class");r[t+1]&&e.classList.add(r[t+1])}else if(r.includes("remove")){const t=r.indexOf("remove");r[t+1]&&e.classList.remove(r[t+1])}else if(r.includes("attr")){const t=r.indexOf("attr");if(r[t+1]){const o=r[t+1],n=r[t+2]||"";if(!e.hasAttribute("data-diffyne-loading-original-"+o)){const t=e.getAttribute(o);null!==t&&e.setAttribute("data-diffyne-loading-original-"+o,t)}e.setAttribute(o,n)}}else e.style.opacity="0.5",e.style.pointerEvents="none"})}hideLoading(e){Array.from(e.querySelectorAll("*")).filter(e=>Array.from(e.attributes).some(e=>e.name.startsWith("diff:loading"))).forEach(e=>{const t=Array.from(e.attributes).find(e=>e.name.startsWith("diff:loading"));if(!t)return;t.value;const r=t.name.split(".");if(r.includes("class")){const t=r.indexOf("class");r[t+1]&&e.classList.remove(r[t+1])}else if(r.includes("remove")){const t=r.indexOf("remove");r[t+1]&&e.classList.add(r[t+1])}else if(r.includes("attr")){const t=r.indexOf("attr");if(r[t+1]){const o=r[t+1],n="data-diffyne-loading-original-"+o;if(e.hasAttribute(n)){const t=e.getAttribute(n);e.setAttribute(o,t),e.removeAttribute(n)}else e.removeAttribute(o)}}else e.style.opacity="",e.style.pointerEvents=""})}observeDOMChanges(){new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{if(e.nodeType===Node.ELEMENT_NODE){e.querySelectorAll("[diff\\:id]").forEach(e=>this.hydrateComponent(e))}})})}).observe(document.body,{childList:!0,subtree:!0})}debounce(e,t){let r;return function(...o){clearTimeout(r),r=setTimeout(()=>e.apply(this,o),t)}}parseJSON(e){try{return JSON.parse(e)}catch{return{}}}getCsrfToken(){const e=document.querySelector('meta[name="csrf-token"]');return e?e.getAttribute("content"):""}updateQueryString(e){const t=new URL(window.location);Object.keys(e).forEach(r=>{null!==e[r]&&""!==e[r]&&void 0!==e[r]?t.searchParams.set(r,e[r]):t.searchParams.delete(r)}),window.history.pushState({},"",t),this.log("Updated URL query string:",e)}handleRedirect(e){const t=e.url,r=void 0===e.spa||e.spa;this.log(`Redirecting to ${t} (SPA: ${r})`),r?this.spaNavigate(t):window.location.href=t}async spaNavigate(e){try{const t=await fetch(e,{headers:{Accept:"text/html"}});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const r=await t.text(),o=(new DOMParser).parseFromString(r,"text/html");document.title=o.title,document.body.innerHTML=o.body.innerHTML,window.history.pushState({},"",e),this.hydrateComponents(),this.log("SPA navigation completed")}catch(t){this.log("SPA navigation failed, falling back to full page reload:",t),window.location.href=e}}generateId(){return"req-"+Math.random().toString(36).substr(2,9)}log(...e){this.config.debug&&console.log("[Diffyne]",...e)}handleError(e){console.error("[Diffyne Error]",e);let t="An error occurred";"validation_error"===e.type&&e.details?.errors||(t="method_error"===e.type?`Method Error: ${e.message}`:"property_error"===e.type?`Property Error: ${e.message}`:"exception"===e.type&&e.details?`${e.details.exception}: ${e.message}\nFile: ${e.details.file}:${e.details.line}`:e.message||"Unknown error occurred",console.error("[Diffyne Error Details]",{type:e.type,message:e.message,details:e.details}),this.config.debug&&alert(t))}}"undefined"!=typeof window&&(window.Diffyne=e,document.addEventListener("DOMContentLoaded",()=>{const t=window.diffyneConfig||{};window.diffyne=new e(t)})),"undefined"!=typeof module&&module.exports&&(module.exports=e)}();
